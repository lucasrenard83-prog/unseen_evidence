<%= turbo_stream.append "messages-list" do %>
  <%= render "messages/message", message: @message %>
  <%= render "messages/message", message: @answer %>
<% end %>

<%= turbo_stream.replace "message_input" do %>
  <input class="form-control string required message-input"
    type="text" name="message[content]" id="message_input"
    placeholder="Your Text Here" required="required"
    aria-required="true" data-speech-target="input">
<% end %>

<%= turbo_stream.update "room_image" do %>
  <% if @message.room.item_found%>
    <img src="<%= @message.room.after_picture_url %>" alt="<%= @message.room.name%>">
  <% else %>
    <img src="<%= @message.room.before_picture_url %>" alt="<%= @message.room.name%>">
  <% end %>
<% end %>

<%= turbo_stream.replace "inventory" do %>
  <div  class="inventory-grid">
    <% Item.where(game_id: @message.game.id).each do |item| %>
      <div class="clue-container <%= item.found ? 'found' : 'not-found' %>">
        <img
          src="<%= item.picture_url %>"
          alt="Picture of <%= item.name %>"
          class="clue-image">

        <% unless item.found %>
          <div class="clue-mask">?</div>
        <% end %>
      </div>
    <% end %>
    </div>
<% end %>

<%= turbo_stream.replace "sidebar" do %>
  <%= render "shared/map", rooms: Room.where(game_id: @message.game.id).order(:position) %>
<% end %>

<% if @item %>
  <%= turbo_stream.append "messages-list" do %>
    <div class="message system-message item-found">
      <strong>You found: <%= @item.name %>!</strong>
      <p><%= @item.description %></p>
    </div>
  <% end %>
<% end %>

<% if @show_code_lock %>
  <%= turbo_stream.append "messages-list" do %>
    <div class="message system-message trapdoor-found">
      <strong><i class="fas fa-lock"></i> You found a trapdoor with a code lock!</strong>
      <p>The lock requires a 4-digit code. You remember the numbers from the papers you found...</p>
      <button class="btn btn-warning mt-2" onclick="document.getElementById('code-lock-modal').style.display='flex'">
        <i class="fas fa-key me-2"></i>Enter Code
      </button>
    </div>
  <% end %>
  <%# Use update instead of append to avoid duplicates %>
  <%= turbo_stream.update "modals-container" do %>
    <div id="code-lock-modal" data-controller="code-lock" data-code-lock-code-value="2129" data-code-lock-room-id-value="<%= @message.room.id %>" style="display: none;">
      <%= render "shared/code_lock_modal" %>
    </div>
  <% end %>
<% end %>
